<form id="invoiceForm" style="max-width:800px;margin:40px auto;padding:30px;background:#f8f3e9;
       border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);font-family:Arial,sans-serif;
       line-height:1.6;color:#333;">
  
  <!-- Logo + Title -->
  <div style="text-align:center;margin-bottom:25px;">
    <img src="https://i.imgur.com/0lppOV5.png" alt="HONEYBITES Logo" 
         style="max-width:150px;margin-bottom:15px;">
    <h2 style="font-size:22px;color:#222;line-height:1.4;margin:0;">
      HONEYBITES BAKERY SDN BHD
    </h2>
    <span style="font-size:18px;color:#444;">E-Invoice Request Application</span>
  </div>

  <!-- Receipt Info -->
  <h3 style="margin:20px 0 10px;color:#444;font-size:18px;">📄 Receipt Information</h3>
  
  <label for="date">Date:</label>
  <input type="text" id="date" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="invoice">Invoice No.:</label>
  <input type="text" id="invoice" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="amount">Amount:</label>
  <input type="text" id="amount" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="terminal">Cashier Terminal:</label>
  <select id="terminal" disabled style="width:100%;margin-bottom:20px;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <option value="">-- Auto Selected --</option>
    <option value="T-01 (Pasar Counter 1)">T-01 (Pasar Counter 1)</option>
    <option value="T-02 (Pasar Counter 2)">T-02 (Pasar Counter 2)</option>
    <option value="T-01 (Lian Yi Counter)">T-01 (Lian Yi Counter)</option>
  </select>

  <!-- Buyer Info -->
  <h3 style="margin:20px 0 10px;color:#444;font-size:18px;">🧾 Buyer Information</h3>

  <label for="name">Name:</label>
  <input type="text" id="name" required placeholder="FULL NAME" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="email">Email:</label>
  <input type="email" id="email" required placeholder="example@mail.com" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="classification">Classification:</label>
  <select id="classification" required style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <option value="">-- Select --</option>
    <option value="Individual">Individual</option>
    <option value="Business">Business</option>
    <option value="Government">Government</option>
  </select>

<!-- Dynamic Sections -->  
<div id="identitySection" style="margin-bottom:15px;display:none;">
  <label for="identityType">Identity:</label>
  <select id="identityType" style="width:100%;margin-bottom:8px;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <option value="">-- Select --</option>
    <option value="MyKad">MyKad</option>
    <option value="MyPR">MyPR</option>
    <option value="MyKAS">MyKAS</option>
    <option value="Army">Army</option>
    <option value="Passport">Passport</option>
  </select>
  <input type="text" id="identityValue" placeholder="Identity No." style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
</div>

<div id="tinSection" style="margin-bottom:15px;display:none;">
  <label for="tinInput">Tax Identification Number (TIN):</label><br>
  <input type="checkbox" id="tinOption"> <span id="tinOptionLabel"></span>
  <input type="text" id="tinInput" style="width:100%;margin-top:8px;padding:8px;border:1px solid #ccc;border-radius:6px;">
</div>

<div id="brnSection" style="margin-bottom:15px;display:none;">
  <label for="brn">Business Registration Number (BRN):</label>
  <input type="text" id="brn" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
</div>

<div id="sstSection" style="margin-bottom:15px;display:none;">
  <label for="sst">SST Registration Number:</label><br>
  <input type="checkbox" id="sstNA"> N/A
  <input type="text" id="sst" style="width:calc(100% - 60px);margin-left:10px;padding:8px;border:1px solid #ccc;border-radius:6px;">
</div>

  <label for="contact">Contact Number:</label>
  <input type="text" id="contact" required placeholder="e.g. 0123456789" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <!-- Address Section (Fixed Size) -->
  <label>Address:</label>
  <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:15px;">
    <textarea id="address1" required placeholder="Address Line 1" style="width:100%;height:50px;resize:none;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>
    <textarea id="address2" placeholder="Address Line 2" style="width:100%;height:50px;resize:none;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>
    <textarea id="address3" placeholder="Address Line 3" style="width:100%;height:50px;resize:none;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>
  </div>

  <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
    <div style="flex:1;min-width:120px;">
      <label>Postcode:</label>
      <input type="number" id="postcode" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
    </div>
    <div style="flex:2;min-width:200px;">
      <label>City:</label>
      <input type="text" id="city" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
    </div>
  </div>

  <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
    <div style="flex:1;min-width:180px;">
      <label>State:</label>
      <select id="state" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
        <option value="">-- Select --</option>
        <option value="Sarawak">Sarawak</option>
        <option value="Sabah">Sabah</option>
        <option value="Johor">Johor</option>
        <option value="Kedah">Kedah</option>
        <option value="Kelantan">Kelantan</option>
        <option value="Melaka">Melaka</option>
        <option value="Negeri Sembilan">Negeri Sembilan</option>
        <option value="Pahang">Pahang</option>
        <option value="Penang">Penang</option>
        <option value="Perak">Perak</option>
        <option value="Perlis">Perlis</option>
        <option value="Selangor">Selangor</option>
        <option value="Terengganu">Terengganu</option>
        <option value="Kuala Lumpur">Kuala Lumpur</option>
        <option value="Putrajaya">Putrajaya</option>
        <option value="Labuan">Labuan</option>
      </select>
    </div>
    <div style="flex:1;min-width:180px;">
      <label>Country:</label>
      <select id="country" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
        <option value="Malaysia">Malaysia</option>
        <option value="Other">Other</option>
      </select>
    </div>
  </div>

  <!-- Clarification -->
  <div style="margin:15px 0;">
    <label style="font-size:14px;color:#444;">
      <input type="checkbox" id="confirm" required> I confirm that the above information is correct...
    </label>
  </div>

  <!-- Submit -->
  <button type="submit" style="width:100%;padding:14px;background:#4a2f00;color:#fff;
          font-weight:bold;border:none;border-radius:8px;cursor:pointer;font-size:16px;transition:0.3s;">
    Submit
  </button>
</form>

<script>
window.onload = function() {
  // --- Helper function for status/warning messages ---
  function showMessage(text, bgColor, textColor) {
    const msg = document.createElement("div");
    msg.innerText = text;
    msg.style.background = bgColor;
    msg.style.color = textColor;
    msg.style.padding = "12px 20px";
    msg.style.marginTop = "15px";
    msg.style.borderRadius = "8px";
    msg.style.fontWeight = "bold";
    msg.style.fontSize = "14px";
    msg.style.textAlign = "center";   // center text
    msg.style.maxWidth = "600px";
    msg.style.marginLeft = "auto";   // center box
    msg.style.marginRight = "auto";
    return msg;
  }

  // --- URL Parameters & Autofill ---
  const params = new URLSearchParams(window.location.search);
  const dateParam = params.get("date");
  const receiptParam = params.get("receipt");
  const totalParam = params.get("total");

  const date = dateParam ? decodeURIComponent(dateParam) : null;
  const receipt = receiptParam ? decodeURIComponent(receiptParam) : null;
  const total = totalParam ? decodeURIComponent(totalParam) : null;

  if (date) document.getElementById("date").value = date.replace(/-/g, "/");
  if (receipt) document.getElementById("invoice").value = receipt;
  if (total) document.getElementById("amount").value = "RM " + total;

  const terminalSelect = document.getElementById("terminal");
  if (receipt) {
    if (receipt.includes("T01")) terminalSelect.value = "T-01 (Pasar Counter 1)";
    else if (receipt.includes("T02")) terminalSelect.value = "T-02 (Pasar Counter 2)";
    else if (receipt.includes("T04")) terminalSelect.value = "T-01 (Lian Yi Counter)";
  }

  // --- Receipt Date Validation ---
  if (date) {
    const [day, month, year] = date.split("-");
    const receiptDate = new Date(`${year}-${month}-${day}`);
    const nextMonth = new Date(receiptDate);
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    const cutoffDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 3);
    const today = new Date();

    if (today > cutoffDate) {
      const form = document.getElementById("invoiceForm");
      if (form) {
        [...form.querySelectorAll("input, select, textarea, button")].forEach(el => el.disabled = true);

        const submitBtn = form.querySelector('[type="submit"]');
        if (submitBtn) submitBtn.style.display = "none";

        // Show validation warning (centered, styled)
        const msg = showMessage(
          "⚠️ Receipt already submitted after the 3rd date of the next month",
          "#fff8c4",  // light yellow
          "#d8000c"   // red
        );
        form.parentNode.appendChild(msg);
      }
    }
  }

  // --- Input Formatting Functions ---
  const formatUpperSingleSpace = el => el.addEventListener("input", function(){
    this.value = this.value.toUpperCase().replace(/\s+/g," ").trimStart();
  });
  const formatLowerNoSpace = el => el.addEventListener("input", function(){
    this.value = this.value.toLowerCase().replace(/\s+/g,"");
  });
  const formatNumberSymbolsOnly = el => el.addEventListener("input", function(){
    this.value = this.value.replace(/[^0-9+()-]/g,"");
  });

  formatUpperSingleSpace(document.getElementById("name"));
  formatLowerNoSpace(document.getElementById("email"));
  formatUpperSingleSpace(document.getElementById("tinInput"));
  formatUpperSingleSpace(document.getElementById("identityValue"));
  formatUpperSingleSpace(document.getElementById("brn"));
  formatUpperSingleSpace(document.getElementById("sst"));
  formatNumberSymbolsOnly(document.getElementById("contact"));
  ["address1","address2","address3"].forEach(id => formatUpperSingleSpace(document.getElementById(id)));

  // --- Section References ---
  const tinInput = document.getElementById("tinInput");
  const tinOption = document.getElementById("tinOption");
  const classification = document.getElementById("classification");
  const tinLabel = document.getElementById("tinOptionLabel");
  const tinSection = document.getElementById("tinSection");
  const identitySection = document.getElementById("identitySection");
  const brnSection = document.getElementById("brnSection");
  const sstSection = document.getElementById("sstSection");

  // --- TIN Checkbox Logic ---
  tinOption.addEventListener("change", function () {
    if (classification.value === "Business") {
      // Business: N/A option
      if (this.checked) {
        tinInput.value = "N/A";
        tinInput.disabled = true;
      } else {
        tinInput.value = "";
        tinInput.disabled = false;
      }
    } else if (classification.value === "Government") {
      // Government: General option
      if (this.checked) {
        tinInput.value = "EI00000000040";
        tinInput.disabled = true;
      } else {
        tinInput.value = "";
        tinInput.disabled = false;
      }
    } else if (classification.value === "Individual") {
      // Individual: General option
      const identityType = document.getElementById("identityType").value;
      if (this.checked) {
        tinInput.value =
          identityType === "Passport" ? "EI00000000020" : "EI00000000010";
        tinInput.disabled = true;
      } else {
        tinInput.value = "";
        tinInput.disabled = false;
      }
    }
  });

  // --- Classification Change Logic (with Identity above TIN for Individual) ---
  classification.addEventListener("change", function () {
    tinSection.style.display = "none";
    identitySection.style.display = "none";
    brnSection.style.display = "none";
    sstSection.style.display = "none";

    // Reset TIN state
    tinOption.checked = false;
    tinInput.value = "";
    tinInput.disabled = false;

    if (this.value === "Business") {
      tinSection.style.display = "block";
      tinLabel.innerText = "N/A"; // ✅ Business shows N/A
      brnSection.style.display = "block";
      sstSection.style.display = "block";
    } else if (this.value === "Government") {
      tinSection.style.display = "block";
      tinLabel.innerText = "General"; // ✅ Government shows General
    } else if (this.value === "Individual") {
      // Show Identity first
      identitySection.style.display = "block";
      tinSection.style.display = "block";
      tinLabel.innerText = "General"; // ✅ Individual shows General

      // Place Identity before TIN
      identitySection.parentNode.insertBefore(identitySection, tinSection);
    }
  });

  // --- Identity Change Handling (for Individual) ---
  document.getElementById("identityType").addEventListener("change", function () {
    if (classification.value === "Individual") {
      tinOption.checked = false;
      tinInput.value = "";
      tinInput.disabled = false;
    }
  });

// --- SST N/A Handling ---
document.getElementById("sstNA").addEventListener("change", function () {
  const sst = document.getElementById("sst");
  if (this.checked) {
    sst.value = "N/A";   // ✅ send N/A instead of empty
    sst.disabled = true;
  } else {
    sst.value = "";
    sst.disabled = false;
  }
});

  // --- Country/State Handling ---
  const country = document.getElementById("country");
  country.addEventListener("change", function(){
    let stateContainer = document.getElementById("state");
    if(this.value==="Malaysia"){
      stateContainer.outerHTML = `<select id="state" style="width:100%;margin-bottom:10px;">
        <option value="">-- Select --</option>
        <option value="Sarawak">Sarawak</option><option value="Sabah">Sabah</option><option value="Johor">Johor</option><option value="Kedah">Kedah</option>
        <option value="Kelantan">Kelantan</option><option value="Melaka">Melaka</option><option value="Negeri Sembilan">Negeri Sembilan</option>
        <option value="Pahang">Pahang</option><option value="Penang">Penang</option><option value="Perak">Perak</option><option value="Perlis">Perlis</option>
        <option value="Selangor">Selangor</option><option value="Terengganu">Terengganu</option><option value="Kuala Lumpur">Kuala Lumpur</option>
        <option value="Putrajaya">Putrajaya</option><option value="Labuan">Labuan</option>
      </select>`;
    } else {
      stateContainer.outerHTML = '<input type="text" id="state" style="width:100%;margin-bottom:10px;" placeholder="Enter State">';
      formatUpperSingleSpace(document.getElementById("state"));
    }
  });

  // --- Web App Submission ---
  const scriptURL = "https://script.google.com/macros/s/AKfycbwMO6DrWSS0LK9ZZ2AFB_0vsEh7vxquJXv0dkEIcYN67ffg1F_FRaTbAB43gONqEh8lCw/exec"; 
  const form = document.getElementById("invoiceForm");
  const submitBtn = form.querySelector('[type="submit"]');

  const statusBar = document.createElement("div");
  statusBar.style.display = "none";
  form.parentNode.appendChild(statusBar);

  form.addEventListener("submit", function(e){
    e.preventDefault();

    const formData = {
      date: document.getElementById("date").value,
      invoice: document.getElementById("invoice").value,
      amount: document.getElementById("amount").value,
      terminal: document.getElementById("terminal").value,
      name: document.getElementById("name").value,
      email: document.getElementById("email").value,
      classification: document.getElementById("classification").value,
      tin: document.getElementById("tinInput").value,
      identityType: document.getElementById("identityType").value,
      identityValue: document.getElementById("identityValue").value,
      brn: document.getElementById("brn").value,
      sst: document.getElementById("sst").value,
      contact: document.getElementById("contact").value,
      address1: document.getElementById("address1").value,
      address2: document.getElementById("address2").value,
      address3: document.getElementById("address3").value,
      postcode: document.getElementById("postcode").value,
      city: document.getElementById("city").value,
      state: document.getElementById("state").value,
      country: document.getElementById("country").value
    };

    statusBar.innerHTML = "";
    statusBar.appendChild(showMessage("⏳ Submitting...", "#cce5ff", "#004085"));
    statusBar.style.display = "block";

    fetch(scriptURL, { method: "POST", body: JSON.stringify(formData) })
      .then(res => res.json())
      .then(data => {
        statusBar.innerHTML = "";
        if(data.status === "success"){
          statusBar.appendChild(showMessage("✅ Submission successful!", "#d4edda", "#155724"));
          form.reset();
        } else {
          statusBar.appendChild(showMessage("❌ Submission failed: " + (data.message || ""), "#f8d7da", "#721c24"));
        }
      })
      .catch(err => {
        statusBar.innerHTML = "";
        statusBar.appendChild(showMessage("❌ Submission failed: " + err, "#f8d7da", "#721c24"));
      });
  });

};
</script>





