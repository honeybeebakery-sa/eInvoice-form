<form id="invoiceForm" style="max-width:800px;margin:40px auto;padding:30px;background:#f8f3e9;
       border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);
       font-family:Arial,sans-serif;line-height:1.6;color:#333;font-size:14px;">

  <style>
    /* Uniform text design for all form fields */
    #invoiceForm input,
    #invoiceForm select,
    #invoiceForm textarea {
      font-family: Arial, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      box-sizing: border-box;
    }

    /* Focus effect for better UX */
    #invoiceForm input:focus,
    #invoiceForm select:focus,
    #invoiceForm textarea:focus {
      border-color: #4a2f00;
      outline: none;
    }

    /* Optional: consistent placeholder styling */
    #invoiceForm ::placeholder {
      color: #888;
    }
  </style>

  <!-- Logo + Title -->
  <div style="text-align:center;margin-bottom:25px;">
    <img src="https://i.imgur.com/0lppOV5.png" alt="HONEYBITES Logo" style="max-width:150px;margin-bottom:15px;">
    <h2 style="font-size:22px;color:#222;line-height:1.4;margin:0;">HONEYBITES BAKERY SDN BHD</h2>
    <span style="font-size:18px;color:#444;">E-Invoice Request Application</span>
  </div>

  <!-- Receipt Info -->
  <h3 style="margin:20px 0 10px;color:#444;font-size:18px;">üìÑ Receipt Information</h3>

  <label for="date">Date:</label>
  <input type="text" id="date" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="invoice">Invoice No.:</label>
  <input type="text" id="invoice" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="amount">Amount:</label>
  <input type="text" id="amount" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="terminal">Cashier Terminal:</label>
  <select id="terminal" disabled style="width:100%;margin-bottom:20px;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <option value="">-- Auto Selected --</option>
    <option value="T-01 (Pasar Counter 1)">T-01 (Pasar Counter 1)</option>
    <option value="T-02 (Pasar Counter 2)">T-02 (Pasar Counter 2)</option>
    <option value="T-01 (Lian Yi Counter)">T-01 (Lian Yi Counter)</option>
  </select>

  <!-- Buyer Info -->
  <h3 style="margin:20px 0 10px;color:#444;font-size:18px;">üßæ Buyer Information</h3>

  <label for="name">Name:</label>
  <input type="text" id="name" required placeholder="FULL NAME" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="email">Email:</label>
  <input type="email" id="email" required placeholder="example@mail.com" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <label for="classification">Classification:</label>
  <select id="classification" required style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <option value="">-- Select --</option>
    <option value="Individual">Individual</option>
    <option value="Business">Business</option>
    <option value="Government">Government</option>
  </select>

  <!-- Dynamic Sections -->
  <div id="identitySection" style="margin-bottom:15px;display:none;">
    <label for="identityType">Identity:</label>
    <select id="identityType" style="width:100%;margin-bottom:8px;padding:8px;border:1px solid #ccc;border-radius:6px;">
      <option value="">-- Select --</option>
      <option value="MyKad">MyKad</option>
      <option value="MyPR">MyPR</option>
      <option value="MyKAS">MyKAS</option>
      <option value="Army">Army</option>
      <option value="Passport">Passport</option>
    </select>
    <input type="text" id="identityValue" placeholder="Identity No." style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
  </div>

  <div id="tinSection" style="margin-bottom:15px;display:none;">
    <label for="tinInput">Tax Identification Number (TIN):</label><br>
    <input type="checkbox" id="tinOption"> <span id="tinOptionLabel"></span>
    <input type="text" id="tinInput" style="width:100%;margin-top:8px;padding:8px;border:1px solid #ccc;border-radius:6px;">
  </div>

  <div id="brnSection" style="margin-bottom:15px;display:none;">
    <label for="brn">Business Registration Number (BRN):</label>
    <input type="text" id="brn" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
  </div>

  <div id="sstSection" style="margin-bottom:15px;display:none;">
    <label for="sst">SST Registration Number:</label><br>
    <input type="checkbox" id="sstNA"> N/A
    <input type="text" id="sst" style="width:calc(100% - 60px);margin-left:10px;padding:8px;border:1px solid #ccc;border-radius:6px;">
  </div>

  <label for="contact">Contact Number:</label>
  <input type="text" id="contact" required placeholder="e.g. 0123456789" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

  <!-- Address Section -->
  <label>Address:</label>
  <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:15px;">
    <textarea id="address1" required placeholder="Address Line 1" style="width:100%;height:50px;resize:none;padding:10px;border:1px solid #ccc;border-radius:6px;"></textarea>
    <textarea id="address2" placeholder="Address Line 2" style="width:100%;height:50px;resize:none;padding:10px;border:1px solid #ccc;border-radius:6px;"></textarea>
    <textarea id="address3" placeholder="Address Line 3" style="width:100%;height:50px;resize:none;padding:10px;border:1px solid #ccc;border-radius:6px;"></textarea>
  </div>

  <!-- Postcode & City Section -->
  <div style="display:flex;gap:10px;margin-bottom:15px;">
    <div style="flex:1;">
      <label>Postcode:</label>
      <input type="text" id="postcode" required placeholder="Enter Postcode" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
    </div>
    <div style="flex:2;">
      <label>City:</label>
      <input type="text" id="city" required placeholder="Enter City" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
    </div>
  </div>

  <!-- State & Country -->
  <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
    <div id="stateWrapper" style="flex:1;min-width:180px;">
      <label>State:</label>
      <select id="state" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
        <option value="">-- Select --</option>
        <option value="Sarawak">Sarawak</option>
        <option value="Sabah">Sabah</option>
        <option value="Johor">Johor</option>
        <option value="Kedah">Kedah</option>
        <option value="Kelantan">Kelantan</option>
        <option value="Melaka">Melaka</option>
        <option value="Negeri Sembilan">Negeri Sembilan</option>
        <option value="Pahang">Pahang</option>
        <option value="Penang">Penang</option>
        <option value="Perak">Perak</option>
        <option value="Perlis">Perlis</option>
        <option value="Selangor">Selangor</option>
        <option value="Terengganu">Terengganu</option>
        <option value="Kuala Lumpur">Kuala Lumpur</option>
        <option value="Putrajaya">Putrajaya</option>
        <option value="Labuan">Labuan</option>
      </select>
    </div>
    <div style="flex:1;min-width:180px;">
      <label>Country:</label>
      <select id="country" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
        <option value="Malaysia">Malaysia</option>
        <option value="Other">Other</option>
      </select>
    </div>
  </div>

  <!-- Clarification -->
  <div style="margin:15px 0;">
    <label style="font-size:14px;color:#444;">
      <input type="checkbox" id="confirm" required> I confirm that the above information is correct...
    </label>
  </div>

  <!-- Submit -->
  <button type="submit" style="width:100%;padding:14px;background:#4a2f00;color:#fff;
          font-weight:bold;border:none;border-radius:8px;cursor:pointer;font-size:16px;transition:0.3s;">
    Submit
  </button>
</form>

<script>
window.onload = function () {
  // --- Helper function for status/warning messages ---
  function showMessage(text, bgColor, textColor) {
    const msg = document.createElement("div");
    msg.innerText = text;
    msg.style.background = bgColor;
    msg.style.color = textColor;
    msg.style.padding = "12px 20px";
    msg.style.marginTop = "15px";
    msg.style.borderRadius = "8px";
    msg.style.fontWeight = "bold";
    msg.style.fontSize = "18px"; // bigger
    msg.style.fontFamily = "Arial, sans-serif";
    msg.style.textAlign = "center";
    msg.style.maxWidth = "600px";
    msg.style.marginLeft = "auto";
    msg.style.marginRight = "auto";
    return msg;
  }

  // --- URL Parameters & Autofill ---
  const params = new URLSearchParams(window.location.search);
  const date = params.get("date");
  const receipt = params.get("receipt");
  const total = params.get("total");

  if (date) document.getElementById("date").value = date.replace(/-/g, "/");
  if (receipt) document.getElementById("invoice").value = receipt;
  if (total) document.getElementById("amount").value = "RM " + total;

  // Terminal auto-select
  const terminalSelect = document.getElementById("terminal");
  if (receipt) {
    if (/T01/i.test(receipt)) {
      terminalSelect.value = "T-01 (Pasar Counter 1)";
    } else if (/T02/i.test(receipt)) {
      terminalSelect.value = "T-02 (Pasar Counter 2)";
    } else if (/T04/i.test(receipt)) {
      terminalSelect.value = "T-01 (Lian Yi Counter)";
    }
  }

  // --- Receipt Date Validation ---
  if (date) {
    const [day, month, year] = date.split("-");
    const receiptDate = new Date(`${year}-${month}-${day}`);
    const nextMonth = new Date(receiptDate);
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    const cutoffDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 3);
    const today = new Date();

    if (today > cutoffDate) {
      const form = document.getElementById("invoiceForm");
      if (form) {
        [...form.querySelectorAll("input, select, textarea, button")].forEach(el => el.disabled = true);

        const submitBtn = form.querySelector('[type="submit"]');
        if (submitBtn) submitBtn.style.display = "none";

        // Show validation warning (top of form)
        const msg = showMessage(
          "‚ö†Ô∏è Receipt already submitted after the 3rd date of the next month",
          "#fff8c4",  // light yellow
          "#d8000c"   // red
        );
        form.parentNode.insertBefore(msg, form);
      }
    }
  }

  // --- Input Formatting Functions ---
  const formatUpperSingleSpace = el => el.addEventListener("input", function(){
    this.value = this.value.toUpperCase().replace(/\s+/g," ").trimStart();
  });
  const formatLowerNoSpace = el => el.addEventListener("input", function(){
    this.value = this.value.toLowerCase().replace(/\s+/g,"");
  });
  const formatNumberSymbolsOnly = el => el.addEventListener("input", function(){
    this.value = this.value.replace(/[^0-9+()-]/g,"");
  });
const formatDigitsOnly = el => el.addEventListener("input", function(){
  this.value = this.value.replace(/\D/g,""); // allow only 0‚Äì9
});
const formatCity = el => el.addEventListener("input", function(){
  this.value = this.value.toUpperCase().replace(/\s+/g," ").trimStart();
});

formatCity(document.getElementById("city"));
formatDigitsOnly(document.getElementById("postcode"));
  formatUpperSingleSpace(document.getElementById("name"));
  formatLowerNoSpace(document.getElementById("email"));
  formatUpperSingleSpace(document.getElementById("tinInput"));
  formatUpperSingleSpace(document.getElementById("identityValue"));
  formatUpperSingleSpace(document.getElementById("brn"));
  formatUpperSingleSpace(document.getElementById("sst"));
  formatNumberSymbolsOnly(document.getElementById("contact"));
  ["address1","address2","address3"].forEach(id => formatUpperSingleSpace(document.getElementById(id)));

  // --- Section References ---
  const tinInput = document.getElementById("tinInput");
  const tinOption = document.getElementById("tinOption");
  const classification = document.getElementById("classification");
  const tinLabel = document.getElementById("tinOptionLabel");
  const tinSection = document.getElementById("tinSection");
  const identitySection = document.getElementById("identitySection");
  const brnSection = document.getElementById("brnSection");
  const sstSection = document.getElementById("sstSection");

  // --- TIN Checkbox Logic ---
  tinOption.addEventListener("change", function () {
    if (classification.value === "Business") {
      if (this.checked) {
        tinInput.value = "N/A";
        tinInput.disabled = true;
      } else {
        tinInput.value = "";
        tinInput.disabled = false;
      }
    } else if (classification.value === "Government") {
      if (this.checked) {
        tinInput.value = "EI00000000040";
        tinInput.disabled = true;
      } else {
        tinInput.value = "";
        tinInput.disabled = false;
      }
    } else if (classification.value === "Individual") {
      const identityType = document.getElementById("identityType").value;
      if (this.checked) {
        tinInput.value =
          identityType === "Passport" ? "EI00000000020" : "EI00000000010";
        tinInput.disabled = true;
      } else {
        tinInput.value = "";
        tinInput.disabled = false;
      }
    }
  });

  // --- Toggle Required Attributes ---
  function setRequired(el, isRequired) {
    if (el) {
      if (isRequired) el.setAttribute("required", "true");
      else el.removeAttribute("required");
    }
  }

  // --- Classification Change Logic ---
  classification.addEventListener("change", function () {
    tinSection.style.display = "none";
    identitySection.style.display = "none";
    brnSection.style.display = "none";
    sstSection.style.display = "none";

    setRequired(tinInput, false);
    setRequired(document.getElementById("identityType"), false);
    setRequired(document.getElementById("identityValue"), false);
    setRequired(document.getElementById("brn"), false);
    setRequired(document.getElementById("sst"), false);

    tinOption.checked = false;
    tinInput.value = "";
    tinInput.disabled = false;

    if (this.value === "Business") {
      tinSection.style.display = "block";
      tinLabel.innerText = "N/A";
      brnSection.style.display = "block";
      sstSection.style.display = "block";

      setRequired(tinInput, true);
      setRequired(document.getElementById("brn"), true);
      setRequired(document.getElementById("sst"), true);

    } else if (this.value === "Government") {
      tinSection.style.display = "block";
      tinLabel.innerText = "General";

      setRequired(tinInput, true);

    } else if (this.value === "Individual") {
      identitySection.style.display = "block";
      tinSection.style.display = "block";
      tinLabel.innerText = "General";

      identitySection.parentNode.insertBefore(identitySection, tinSection);

      setRequired(document.getElementById("identityType"), true);
      setRequired(document.getElementById("identityValue"), true);
      setRequired(tinInput, true);
    }
  });

  // --- Identity Change Handling ---
  document.getElementById("identityType").addEventListener("change", function () {
    if (classification.value === "Individual") {
      tinOption.checked = false;
      tinInput.value = "";
      tinInput.disabled = false;
    }
  });

  // --- SST N/A Handling ---
  document.getElementById("sstNA").addEventListener("change", function () {
    const sst = document.getElementById("sst");
    if (this.checked) {
      sst.value = "N/A";
      sst.disabled = true;
    } else {
      sst.value = "";
      sst.disabled = false;
    }
  });

  // --- Country/State Handling ---
  const country = document.getElementById("country");
  country.addEventListener("change", function () {
    let stateWrapper = document.getElementById("stateWrapper");

    if (this.value === "Malaysia") {
      stateWrapper.innerHTML = `
        <label for="state">State:</label>
        <select id="state" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
          <option value="">-- Please select a state --</option>
          <option value="Sarawak">Sarawak</option><option value="Sabah">Sabah</option><option value="Johor">Johor</option><option value="Kedah">Kedah</option>
          <option value="Kelantan">Kelantan</option><option value="Melaka">Melaka</option><option value="Negeri Sembilan">Negeri Sembilan</option>
          <option value="Pahang">Pahang</option><option value="Penang">Penang</option><option value="Perak">Perak</option><option value="Perlis">Perlis</option>
          <option value="Selangor">Selangor</option><option value="Terengganu">Terengganu</option><option value="Kuala Lumpur">Kuala Lumpur</option>
          <option value="Putrajaya">Putrajaya</option><option value="Labuan">Labuan</option>
        </select>`;
    } else {
      stateWrapper.innerHTML = `
        <label for="state">State / Province / Region:</label>
        <input type="text" id="state" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;" placeholder="Enter state / province / region">`;
      formatUpperSingleSpace(document.getElementById("state"));
    }

    let newState = document.getElementById("state");
    setRequired(newState, true);
  });

  // --- Form Submission ---
  const scriptURL = "https://script.google.com/macros/s/AKfycbwMO6DrWSS0LK9ZZ2AFB_0vsEh7vxquJXv0dkEIcYN67ffg1F_FRaTbAB43gONqEh8lCw/exec";
  const form = document.getElementById("invoiceForm");
  const statusBar = document.createElement("div");
  statusBar.style.display = "none";
  form.parentNode.appendChild(statusBar);

form.addEventListener("submit", function(e){
  e.preventDefault();

  const formData = Object.fromEntries(new FormData(form).entries());

  statusBar.innerHTML = "";

  const submittingMsg = document.createElement("div");
  submittingMsg.textContent = "‚è≥ Submitting...";
  submittingMsg.style.background = "#cce5ff";
  submittingMsg.style.color = "#004085";
  submittingMsg.style.fontSize = "18px";
  submittingMsg.style.fontFamily = "Arial, sans-serif";
  submittingMsg.style.fontWeight = "bold";
  submittingMsg.style.padding = "12px";
  submittingMsg.style.marginBottom = "10px";
  submittingMsg.style.border = "1px solid #004085";
  submittingMsg.style.borderRadius = "6px";
  submittingMsg.style.textAlign = "center";

  statusBar.appendChild(submittingMsg);
  statusBar.style.display = "block";

  fetch(scriptURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" }, // <-- Add this
    body: JSON.stringify(formData)
  })
  .then(res => res.json())
  .then(data => {
    statusBar.innerHTML = "";
    const msg = document.createElement("div");

    if (data.status === "success") {
      msg.textContent = "‚úÖ Submission successful!";
      msg.style.background = "#d4edda";
      msg.style.color = "#155724";
      form.reset();
    } else {
      msg.textContent = "‚ùå Submission failed: " + (data.message || "");
      msg.style.background = "#f8d7da";
      msg.style.color = "#721c24";
    }

    msg.style.fontSize = "18px";
    msg.style.fontFamily = "Arial, sans-serif";
    msg.style.fontWeight = "bold";
    msg.style.padding = "12px";
    msg.style.marginBottom = "10px";
    msg.style.border = "1px solid currentColor";
    msg.style.borderRadius = "6px";
    msg.style.textAlign = "center";

    statusBar.appendChild(msg);
  })
  .catch(err => {
    statusBar.innerHTML = "";
    const msg = document.createElement("div");
    msg.textContent = "‚ùå Submission failed: " + err;
    msg.style.background = "#f8d7da";
    msg.style.color = "#721c24";
    msg.style.fontSize = "18px";
    msg.style.fontFamily = "Arial, sans-serif";
    msg.style.fontWeight = "bold";
    msg.style.padding = "12px";
    msg.style.marginBottom = "10px";
    msg.style.border = "1px solid #721c24";
    msg.style.borderRadius = "6px";
    msg.style.textAlign = "center";

    statusBar.appendChild(msg);
  });
});
</script>
